<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/defaultLayout}">
    <head>
        <title>게시글 작성</title>
        <th:block layout:fragment="css">
            <link rel="stylesheet" th:href="@{/css/home.css}">
        </th:block>
        <link rel="stylesheet" th:href="@{/css/searchBar.css}">
        <link rel="stylesheet" th:href="@{/css/ckeditor5/editorStyle.css}">
		<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/46.0.3/ckeditor5.css" crossorigin>
        <link rel="stylesheet" th:href="@{/css/community/writeForm.css}">
        <style>
            .ck-content img,
            .content-display img {
                max-width: 100%;
                height: auto;
                /* 원본 비율 유지 */
            }
            .decoration {
                width: 100%;
                border-radius: 30px;
                padding: 30px;
                border: 1px solid black;
                background-color: white;
            }
        </style>
        <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    </head>
    <body>
        <section class="mainField" aria-label="메인 영역" layout:fragment="content">
            <div class="searchSection">
                <div class="categorySection">
                    <select name="category" id="categoryDropdown">
                        <option value="all" selected>전체</option>
                        <option value="즐겨찾는 게시판">즐겨찾는 게시판</option>
                        <option value="자유게시판">자유게시판</option>
                        <option value="IT">IT</option>
                        <option value="일본어">일본어</option>
                        <option value="일본 생활&문화">일본 생활&문화</option>
                        <option value="취업&꿀팁">취업&꿀팁</option>
                        <option value="취미&여행&맛집">취미&여행&맛집</option>
                        <option value="자격증">자격증</option>
                        <option value="졸업생">졸업생</option>
                    </select>
                </div>

                <div class="searchBar">
                    <input type="text" placeholder="검색">
                </div>

                <button class="writeBtn" type="button" id="writePostBtn">글쓰기 ✏️</button>
            </div>
            <div class="decoration">
                <a th:href="@{home}">홈으로 돌아가기</a>
                <input type="hidden" id="postId" th:value="${post.postId}">
                <div class="authorInfoAndBtns">
                    <div class="authorInfo">
                        <!-- 작성자 정보와 프로필 사진 불러오기 -->
                    </div>
                    <button type="button" id="deletePostBtn">삭제하기</button>
                    <button type="button" id="updatePostBtn">수정하기</button>
                </div>
                <div class="updatedTime">
                    <div class="updatedTimeDisplay" th:if="${post.updatedTime}"
                        th:text="${}"></div>
                </div>
                <div class="title">
                    <div class="titleDisplay" th:text="${post.title}"></div>
                </div>
                <div class="content">
                    <div class="contentDisplay" th:utext="${post.content}"></div>
                </div>
                <div class="likeAndCommentCount">
                    <div class="likeCountDisplay" th:text="${post.likeCount}"></div>
                    <!-- 비동기 방식으로 댓글 개수 불러오기 -->
                    <div class="commentCountDisplay"></div>
                </div>
                <div class="writeComment">
                    <input type="text" name="commentForm" id="commentBox">
                    <button type="button" id="inputCommentBtn">댓글 작성</button>
                </div>
                <div class="comments">
                    <!-- 비동기 방식으로 댓글 불러오기 -->
                    <table>
                        <tbody id="commentTbody">
                        </tbody>
                    </table>
                </div>
                <!-- 현재 로그인 유저의 id를 저장 -->
                <!-- 로그인 기능 구현 시 현재 로그인 중인 유저의 값을 불러오도록 수정해야 함 -->
                <input type="hidden" id="currentUser" value="demoUser">
            </div>
        </section>
        <th:block layout:fragment="script">
            <script>
                $('#writePostBtn').click(function() {
                    location.href = 'writePost';
                });
                $('#deletePostBtn').click(function() {
                    const flag = confirm("정말로 이 게시글을 삭제하시겠습니까?");
                    if(flag) {
                        const postId = $('#postId').val();
                        location.href = `deletePost/${postId}`;
                    }
                });
                $('#updatePostBtn').click(function() {
                    const postId = $('#postId').val();
                    location.href = `updatePost/${postId}`;
                });
            </script>
            <script>
                $(document).ready(function() {
                    // 목록 가져오기
                    commentList();

                    // 댓글 작성
                    $('#inputCommentBtn').on('click', inputButtonClick);

                    // 이벤트 위임
                    // $(부모 요소).on(
                    //		'이벤트명',
                    //		자식요소 선택자(클릭대상이 될 요소),
                    //		함수
                    //	)
                    // 상위 요소에 이벤트를 등록해두고, 이벤트를 가로채서 하위 요소에 처리
                    $('#commentTbody').on('click', '.deleteButton', deleteFunc);
                    $('#commentTbody').on('click', '.updateButton', updateFunc);
                });
                
                // 댓글 저장
                function inputButtonClick() {
                    // 작성자명 불러오기 : 현재 로그인 중인 유저의 이름을 불러와야 함
                    let postId   = $('#postId').val();
                    let userName = $('#currentUser').val();
                    let content  = $('#commentBox').val().trim();
                    
                    if (content == '') {
                        alert('댓글 내용을 입력하세요.');
                        return;
                    }
                    
                    $.ajax({
                        url: 'writeComment',
                        type: 'post',
                        data: {
                            postId: postId,
                            userName: userName,
                            content: content},
                        success: function() {
                            $('#comment').val('');
                            // 댓글 목록 재로딩
                            commentList();
                        },
                        error: function() {
                            alert('댓글을 저장하지 못했습니다.');
                        }
                    });
                }
                
                // 댓글 목록 불러오기
                function commentList() {
                    let data = { postId: $('#postId').val() };
                    $.ajax({
                        url: 'commentList',
                        type: 'get',
                        data: data,
                        dataType: 'json',
                        success: function(commentList) {
                            let str = ``;
                            let commentCount = 0;
                            
                            if (!commentList || commentList.length == 0) {

                            } else {
                                $(commentList).each(function(i, ob) {
                                    str += `
                                        <tr>
                                            <td>${ob.userName}</td>
                                            <td class="commentContent" id="content${ob.commentId}">${ob.content}</td>
                                            <td>
                                                <button class="deleteButton"
                                                        data-commentid="${ob.commentId}">삭제</button>
                                            </td>
                                            <td>
                                                <button class="updateButton"
                                                        data-commentid="${ob.commentId}"
                                                        data-content="${ob.content}">수정</button>
                                            </td>
                                        </tr>
                                    `;
                                    commentCount++;
                                });
                            }
                            
                            $('#commentTbody').html(str);
                            $('.commentCountDisplay').val(commentCount);
                            
                            //이벤트 등록
                        },
                        error: function() {
                            alert('댓글 목록 조회 실패');
                        }
                    });
                }
                
                // 삭제
                function deleteFunc() {
                    let result = confirm("정말로 이 댓글을 삭제하시겠습니까?");
                    
                    if (result) {
                        // 정말 이상하게도 id -> Id로 표기 시 에러 남
                        let commentId = $(this).data('commentid');
                        $.ajax({
                            url: `deleteComment/${commentId}`,
                            type: 'delete',	 //HTTP 메서드 방식(삭제)
                            success: function() {
                                commentList();
                            },
                            error: function() {
                                alert('삭제 실패');
                            }
                        });
                    }
                }
                
                // 수정
                function inputConfirmFunc(updateCommentButtonId, commentBoxId) {
                    return new Promise((resolve) => {
                        const updateButton = document.getElementById(updateCommentButtonId);
                        
                        // 취소 버튼 생성
                        const cancelButton = document.createElement('button');
                        cancelButton.textContent = '취소';
                        cancelButton.type = 'button';
                        updateButton.parentNode.appendChild(cancelButton);
                        
                        function handleUpdate() {
                            const updateText = document.getElementById(commentBoxId).value;
                            cleanup();
                            resolve({ action: 'update', text: updateText });
                        }
                        
                        function handleCancel() {
                            cleanup();
                            resolve({ action: 'cancel', text: null });
                        }
                        
                        function cleanup() {
                            updateButton.removeEventListener('click', handleUpdate);
                            cancelButton.removeEventListener('click', handleCancel);
                            cancelButton.remove();
                        }
                        
                        updateButton.addEventListener('click', handleUpdate);
                        cancelButton.addEventListener('click', handleCancel);
                    });
                }

                async function updateFunc() {
                    const commentId = $(this).data('commentid');
                    const commentData = $(this).data('content');
                    
                    const commentAreaId = '#content' + commentId;
                    const originalContent = $(commentAreaId).html(); // 원래 내용 저장
                    
                    const commentBoxId = 'commentBox' + commentId;
                    const updateCommentButtonId = 'updateComment' + commentId + 'Button';
                    
                    // input 폼으로 변경
                    const commentAreaStr = `
                        <input id="${commentBoxId}" value="${commentData}">
                        <button type="button" id="${updateCommentButtonId}">수정</button>
                    `;
                    $(commentAreaId).html(commentAreaStr);
                    
                    try {
                        const result = await inputConfirmFunc(updateCommentButtonId, commentBoxId);
                        
                        if (result.action === 'cancel') {
                            // 취소 시 원래 내용으로 복원
                            $(commentAreaId).html(originalContent);
                            return;
                        }
                        
                        // 수정 진행
                        if (result.text && result.text.trim() !== '') {
                            const updateData = {
                                commentId: commentId,
                                content: result.text
                            };
                            console.log(updateData);
                            
                            // 성공 시 새로운 내용으로 표시
                            $(commentAreaId).html(result.text);

                            // Ajax 요청
                            $.ajax({
                                url: 'updateComment',
                                type: 'patch',
                                data: JSON.stringify(updateData),
                                contentType: 'application/json',
                                success: function() {
                                    commentList(); // 댓글 목록 새로고침
                                },
                                error: function() {
                                    alert('수정 실패');
                                    // 실패 시 원래 내용으로 복원
                                    $(commentAreaId).html(originalContent);
                                }
                            });
                        } else {
                            alert('수정할 내용을 입력해주세요!');
                            $(commentAreaId).html(originalContent);
                        }
                    } catch (error) {
                        $(commentAreaId).html(originalContent);
                    }
                }
            </script>
        </th:block>
    </body>
</html>